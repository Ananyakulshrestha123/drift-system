/* REXX */
/* Change this to your PDS name */
pds = "'YOUR.HLQ.PDSNAME'"

ADDRESS TSO
/* Step 1: List members into a temp dataset and read them into a stem */
"LISTDS "pds" MEMBERS"  "STACK"
memCount = 0

/* Step 2: Parse the output of LISTDS */
DO WHILE QUEUED() > 0
    PARSE PULL line
    /* Member list usually starts after 'Members' header and is space separated */
    IF WORDPOS("MEMBER",line) > 0 THEN ITERATE
    IF SUBSTR(line,1,1) = ' ' THEN DO
        DO i = 1 TO WORDS(line)
            memCount = memCount + 1
            members.memCount = WORD(line,i)
        END
    END
END

IF memCount = 0 THEN DO
    SAY "No members found in" pds
    EXIT
END

/* Step 3: Read each member content */
DO i = 1 TO memCount
    memName = members.i
    SAY "---------------------------------------"
    SAY "Reading member:" memName
    SAY "---------------------------------------"

    /* Allocate this member */
    "ALLOC FI(INFILE) DA("pds"("memName")) SHR REUSE"

    /* Read content into stem */
    "EXECIO * DISKR INFILE (STEM data. FINIS"

    /* Display lines */
    DO j = 1 TO data.0
        SAY data.j
    END

    /* Free the DD */
    "FREE FI(INFILE)"
END

EXIT








/* REXX */
srcPDS  = "'FSTT.EJCK.JCL.CHECK'"
outPDS  = "'FSTT.OUTPUT.EJCKJCL'"

ADDRESS TSO
"OUTTRAP(cmdout.)"
"LISTDS "srcPDS" MEMBERS"
"OUTTRAP(OFF)"

/* Extract member names */
memCount = 0
DO i = 1 TO cmdout.0
    line = STRIP(cmdout.i)
    IF line = '' THEN ITERATE
    IF POS('----',line) > 0 THEN ITERATE
    IF POS('MEMBER',line) > 0 THEN ITERATE
    DO j = 1 TO WORDS(line)
        memCount = memCount + 1
        members.memCount = WORD(line,j)
    END
END

IF memCount = 0 THEN DO
    SAY "No members found in" srcPDS
    EXIT
END

/* Loop through members */
DO i = 1 TO memCount
    memName = members.i
    SAY "Running EJCK for:" memName

    /* Run EJCK and trap output */
    "OUTTRAP(chkout.)"
    "EJCK DATASET("srcPDS"("memName"))"
    "OUTTRAP(OFF)"

    /* Save EJCK output in output PDS */
    "ALLOC FI(OUTDD) DA("outPDS"("memName")) SHR REUSE"
    DO k = 1 TO chkout.0
        outLine.k = chkout.k
    END
    outLine.0 = chkout.0
    "EXECIO "outLine.0" DISKW OUTDD (STEM outLine. FINIS"
    "FREE FI(OUTDD)"
END

SAY "EJCK completed for" memCount "members."
EXIT
